---
layout: post
title: Intro to occupancy 
bigimg: /img/big-img/trawling.png
tags: [tutorial, occupancy, jags]
---

Outline
=======

Preliminaries
=============

    set.seed(1111)

    plot(runif(10))

![](/img/2020-05-23-occupancy-1_files/unnamed-chunk-3-1.png)

    getwd()

    ## [1] "C:/Users/mcolvin/Documents/Teaching/WFA8000-Research-Credits/_Example-R-codes"

???
===

Generating some occupancy data
==============================

    nsites<- 450

    nreps<-3## number of samples done in a site

    b0<- 1.75
    b1<- -0.02

    occ_covs<- data.frame(site=c(1:nsites),
        ele=rnorm(nsites, 0,1),
        X1=rnorm(nsites,0,1),
        X2=rnorm(nsites,0,1))
    y<- model.matrix(~ele,occ_covs) %*% c(b0,b1)
    psi<- plogis(y)

    # detection
    c0<- 0.4  ## intercept seine
    c1=-1.5 ## effect of trawl
    c2= 1.5 ## effect of covariate y3
    # DATA.FRAME OF DETECTION COVARITES SORTED BY SITE AND OCCASION WITHIN SITE
    det_covs<-expand.grid(
        site=c(1:nsites), 
        rep=c(1:3))
    det_covs<- det_covs[order(det_covs$site,
        det_covs$rep),] ## sort by site and rep within site that is how unmarked likes the data
    ## GEAR  
    det_covs$gear<- sample(c("seine","trawl"),
        nsites*nreps,replace=TRUE)
    det_covs$gear<-factor(det_covs$gear)
    ## add 2 sham variables to as detection covariates (global model = dcv+Y1+Y2)
    det_covs$Y1<- rnorm(nrow(det_covs),0,1) ## SCALED TO MEAN 0 AND SD = 1
    det_covs$Y2<- rnorm(nrow(det_covs),0,1) 
    det_covs$Y3<- rnorm(nrow(det_covs),0,1)
    yy<- model.matrix(~gear+Y3,det_covs)%*% c(c0,c1,c2)

    p<-matrix(0,nrow=nsites,ncol=nreps)
    ## MAKE P INTO A MATRIX
    for(i in 1:nsites)
        {
        for(k in 1:nreps)
            {## TRASNFORM TO PROBABILITY
            p[i,k]<-plogis(yy[which(det_covs$site==i&det_covs$rep==k)])
            }
         }
        

    ## simulate detections for 3 replicates in each site
    Z<- rbinom(nsites,1,psi) ## SITE OCCUPIED OR NOT
    # detection matrix each row is a site
    y<-matrix(0,nrow=nsites,ncol=nreps)## MATRIX OF DETECTION HISTORIES
    for(k in 1:nreps)
        {
        y[,k]<-rbinom(nsites,1,p[,k]*Z)
        }

DONE GENERATING DATA TO FIT MODEL TO
------------------------------------

MODEL SELECTION USING ALL POSSIBLE COMBINATIONS
===============================================

    occ_model_covs<-c("ele","X1","X2")
    det_model_covs<- c("gear","Y1","Y2","Y3")

    ## MAKE ALL POSSIBLE COMBINATIONS OF OCCUPANCY COVARIATES
    occ_models<- c()
    for(i in 1:length(occ_model_covs))
        {
        occ_models<- c(occ_models,
            unlist(apply(combn(occ_model_covs,i),2,paste,collapse="+")))
        }

    ## MAKE ALL POSSIBLE COMBINATIONS OF DETECTION COVARIATES
    det_models<- c()
    for(i in 1:length(det_model_covs))
        {
        det_models<- c(det_models,unlist(apply(combn(det_model_covs,i),2,paste,collapse="+")))
        }   
    ## ALL COMBOS OF OCCUPANCY AND DETECTION 
    ### DETCTION MODLE GOES FIRST IN OCCU
    models<- expand.grid(det=det_models, occ=occ_models,stringsAsFactors = FALSE) 
    models<- apply(models,1,paste,collapse="~") 
    models<-paste("~",models,sep="") ## add front tilda for unmarked  
    library(unmarked)
    library( AICcmodavg)
    ## GET DATA FORMATED FOR UNMARKED
    um_dat<- unmarkedFrameOccu(y, 
        siteCovs=occ_covs, 
        obsCovs=det_covs)

    ## FIT THE TRUE MODEL
    fit<- occu(~gear+Y3~ele,um_dat)
    cbind(coef(fit),c(b0,b1,c0,c1,c2))## does ok for detection covs, occupancy not so much

    ##                    [,1]  [,2]
    ## psi(Int)      2.2035039  1.75
    ## psi(ele)     -0.1640028 -0.02
    ## p(Int)        0.4123712  0.40
    ## p(geartrawl) -1.5227671 -1.50
    ## p(Y3)         1.5961483  1.50

    ## SO OF THE 2 ANALYSIS IS MOST ROBUST TO ESTIMATE DETECTION PROBABLITIES

    ## FIT ALL THE MODELS AND EXTRACT AIC
    output<-data.frame()
    for(m in 1:length(models))
        {
        fit<- occu(as.formula(models[m]),um_dat)
        output<-rbind(output,data.frame(model=models[m],
            nll=fit@negLogLike,
            covergence=fit@opt$convergence,
            covergence_message=ifelse(is.null(fit@opt$message),"None",fit@opt$message),
            AIC=fit@AIC))
        }

    ## MODEL SELECTION
    output<-output[order(output$AIC),]
    output$daic<- output$AIC-min(output$AIC)
    output$model_lik<- exp(-0.5*output$daic)
    output$model_weight<- output$model_lik/sum(output$model_lik)
